## Archive of Work-in-Progress
_(sorted by descending date)_


#### PLX-1008: MVP1 part5
- Update dependencies and vulnerabilities
  - GOAL: deal with major updates (Typescript 5, Eslint, Jest, etc.)
  - Get rid of vulnerabilities ASAP
  - Update with breaking changes
- Remove useless dependencies for lambda bundle
  - remove from main package.json to make `npm ci` faster
  - common package.json and tsconfig.json for dev/build steps
  - changed structure to src/core and src/app/<awsLambda|server>
  - every app has its specific package.json with production dependencies
  - changed operations script after the new structure
  - add package-scripts.sh to wrap multiple commands that needs to be run together
    - clean
      - rm -rf **/release*.zip 2>/dev/null (only 1 *?)
      - rm -rf **/dist 2>/dev/null
      - rm -rf **/coverage 2>/dev/null
      - remove local "clean" from package.json(s)
    - install
      - npm ci
      - cd src/app/awsLambdas; npm ci
      - cd src/app/server; npm ci - problem "Cannot find module... Please verify that the package.json has a valid "main" entry"
    - reset
      - ask for confirmation
      - full clean
      - rm -rf **/node_modules 2>/dev/null
  - added "notes" to package.json https://bobbyhadz.com/blog/add-comments-to-package-json
  - update docs with snippets and bash notes
  - update README
  - create apps README
- Add the final logger
  - GOAL: do not log with console
  - Introduce pino-logger (+ research for alternatives)
    - !! Do before the code starts growing up
    - add pino-http for express/koa https://www.makeuseof.com/node-js-logging-top-packages/
  - Deploy and check: error stacks should point to the exact line of source TS code
  - Add flag to activate verbose test logs
- Test production packages inside app directory
  - pino is in the main node_modules
  - for lambda app there are no production packages
  - tested with lodash chunk into lambda handler: it works

#### PLX-1007: MVP1 part4
- GitHub actions: introduction
  - GOAL: final ci/cd setup
  - diff deploy-wf by ENV
    - https://docs.github.com/en/actions/learn-github-actions/contexts#example-usage-of-the-vars-context
    - keep it simple: work on a single file based on DEV environment
  - prepare bash scripts for deploy
    - make them working locally
    - make them working locally with docker
    - differentiate deploy and deploy-static
  - renamed directory "pipeline" to "operations"
  - Workflow: Shared docker image for build and deploy
    - run job on demand
    - build and publish on personal docker
    - get/set secrets for personal docker
  - Workflow: Build, release, deploy
    - Test, build, release
      - run job on demand (prevent useless builds)
      - build specific image FROM (1)
      - run container (no ENV)
    - Deploy
      - run job on demand
      - build specific image FROM (1)
      - run container (by ENV)


#### PLX-1006: MVP1 part3
- GitHub actions: introduction
  - GOAL: preparation for a proper ci/cd setup
  - start with very basic action
    - example-wf1.yml
    - run a bash script
      https://stackoverflow.com/questions/65609835/run-a-bash-script-located-in-public-folder-github-actions
    - run into docker containers
      https://stackoverflow.com/questions/61154750/use-local-dockerfile-in-a-github-action
  - setup action for build-release w/ aws secrets
  - setup action for deploy w/ aws secrets
  - ARE DOCKER IMAGES REALLY NEEDED?
    - run scripts in GitHub container
    - use aws actions or cli?
    - decided to go with bash scripts instead of docker
  - split build-release.sh into small reusable steps for build, test, release
  - prepare bash scripts for build-release
    - make them working locally
    - make them working locally with docker
  - introduced aws-release.utils.sh for simple operations, centralize ops, and better clarity
  - (done) Research possibilities for automatic logs from API-Gateway
    - GOAL: more knowledge on aws-gw
    - See ApiGw1StageV1 AccessLogSettings
  - Manage lifecycle for releases on S3
    - Decision: won't do - Enabling S3 versioning is not free
    - GOAL: prevent uncontrolled growth of release packages
    - STEPS:
      - remove simple releases after 1 month
      - apply retention days on s3 buckets?
      - keep releases of main branch?
      - define directories to differentiate what to delete and what to keep
    - WIP:
      - created a copy of object + created a rule
      - wait until 11 Jun at 16:00 and something should be deleted
      - try with 1 non-current-version objects retained
      - set up the rule in [plaax-stack-static.aws-cfn.yml](..%2Foperations%2Fplaax-stack-static.aws-cfn.yml)


#### PLX-1005: MVP1 part2
- Create the initial form of a final API-Layer
  - finalize the simple controller to lambda (hello-world)
  - functions directory
  - functions/apiLambdaHandler.ts
  - api directory is for controllers (add readme?) ... that can be integrated everywhere
  - decide the most important endpoints (at the moment)
  - create API routes for some basic endpoints
  - copy only handler and code specific for a lambda
  - add meaningful logs for incoming requests in main lambda api handler
  - handle static resources with aws cloudformation
    - stack for lambda, api, etc.
    - stack for s3, dynamodb, etc.
    - script for stack-static operations
    - renamed dynamodb tables as "stack-env-..."
  - focus on 1 simple controller for 'userProjects'
    - concept for jest tests and mocks
    - install aws libs as dev dependencies (already present in lambda node-runtime)
    - jest mock aws in __mocks__ folder
    - unit-tests for Repository
      - get real data from scripts in 'dev' folder
      - save aws data (json files) in repo/__tests__/__data__
      - save repo data (ts files) in repo/__tests__/__data__
      - use repo data (ts files) in repo tests as expected data
      - use repo data (ts files) in higher levels for mocking response from repo
    - working api: integrate user+board repo calls in API + lambdaAPI
    - unit-tests for ApiControllers
    - unit-tests for internalLambdaApiHandler
    - create integration test stub
    - deploy and test with new handler, test entire flow
    - create initial integration test for api lambda
  - focus on 1 controller for 'getUserBoard' and implement the whole chain
    - add repo function + tests
    - add api controller + tests
    - add lambda route handler + tests
    - add lambda integration tests
    - deploy and test
  - extra-work and nice-to-have
    - Unit-Test single api controller
    - Unit-Test data repository
    - Unit-Test dynamodb-gateway
    - Centralize DynamoDb config (and functions?) w/ dependency on ENV_NAME
    - Create one-time cloudformation templates
    - create S3 bucket for release
    - create dynamo-db tables by env
    - (done/not-possible - time-boxed 1h) try to split api-gw into another file (dir "/aws-cfn-resources"): not possible from local yml files


#### PLX-1004: MVP1 part1
- Build 1
  - Upload zip to S3 with commit short
  - Bash-Script for distribution
  - Create a docker image for build and release
- Deploy 1
  - (ref) https://octopus.com/blog/deploying-lambda-cloudformation
  - Prepare Cloudformation script
  - CFN-Deploy Lambda, Log, Authorizer in 1 YAML file
  - Accept external params for env-name
  - (postponed) Split YAML file in multiple files (?)
- Deploy 2
  - Create 1 Bash script for deployment
  - rename "aws-cfn-stack.sh" to "plaax-stack.aws-cfn.operations.sh" (+local)
  - (not-needed... too many layers) create "deploy.sh"/"deploy.local.sh" (wrap "plaax-stack.aws-cfn.operations.sh")
  - Create a docker image for deployment
    - "deploy.dockerfile"
    - (postponed - todo added) basic linux image
    - same approach like build-release.dockerfile
    - "deploy.dockerfile.local.sh"
- Build 2
  - throw Error (from src/nested-dir/dir2/...) included in the handler
  - check what happens with Error info...
  - add source maps
- Build and deploy local zip files with CFN
  - just replace lambda code (script for build, zip, replace lambda code) ?
  - (or) local scripts uses a different hash
  - make release hash generic (not linked to git commit short)
  - rename zip files with "plaax-<hash>.zip"
  - handle missing release hash
- Deploy API-Gateway
  - (ref) https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_ApiGatewayV2.html
  - (ref / api-gw-cfn) https://gist.github.com/toddlers/7c324e39c2ef3058d6c50b895076b16f
  - deploy stand-alone GW with CFN
  - trigger lambda with GW
  - fix names for api-gw stuff in CFN template, fix Stack name
